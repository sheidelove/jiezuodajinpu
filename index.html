<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>杰作打金黄金价盘</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: #1e293b; min-height: 100vh; overflow: hidden; position: relative;
        }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; pointer-events: none; z-index: 0; }
        .container { width: 100vw; height: 100vh; background: #1e293b; overflow: hidden; display: flex; flex-direction: column; position: relative; z-index: 1; }
        .container::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(45deg, transparent 0%, rgba(70,130,180,0.05) 25%, transparent 50%, rgba(75,85,99,0.04) 75%, transparent 100%);
            pointer-events: none; z-index: -1;
        }
        .header { background: #1e293b; padding: 1.5vh 4vw; text-align: center; position: relative; flex-shrink: 0; border-bottom: 1px solid #334155; }
        .header::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(90deg, transparent 0%, rgba(70,130,180,0.15) 50%, transparent 100%);
            animation: subtleShine 4s ease-in-out infinite; pointer-events: none;
        }
        @keyframes subtleShine { 0%, 100% { opacity: 0; } 50% { opacity: 0.6; } }
        .title { color: #fff; font-size: 3.5vw; font-weight: 600; margin-bottom: 0.8vh; letter-spacing: 0.02em; }
        .timestamp { color: #94a3b8; font-size: 1.6vw; display: flex; justify-content: space-between; align-items: center; font-weight: 400; }
        .price-tables-container { display: flex; gap: 2vw; flex: 1; height: 0; padding: 1vh 1.5vw 1.5vh 1.5vw; position: relative; }
        .price-tables-container::before { 
            content: ''; position: absolute; top: 50%; left: 50%; width: 2px; height: 80%; 
            background: linear-gradient(to bottom, transparent 0%, rgba(70,130,180,0.4) 20%, rgba(70,130,180,0.6) 50%, rgba(75,85,99,0.4) 80%, transparent 100%);
            transform: translate(-50%, -50%); box-shadow: 0 0 8px rgba(70,130,180,0.3);
        }
        .price-section { 
            flex: 1; display: flex; flex-direction: column; background: #1e293b; border-radius: 20px; border: 2px solid rgba(70,130,180,0.25);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1), 0 0 12px rgba(70,130,180,0.15);
            backdrop-filter: blur(15px);
        }
        .price-table { width: 100%; border-collapse: collapse; background: #1e293b; flex: 1; height: 0; border-radius: 15px; overflow: hidden; }
        .table-header { background: #1e293b; }
        .table-header th { 
            color: #94a3b8; padding: 1.8vh 1.5vw; text-align: center; font-size: 2.2vw; font-weight: 500; 
            border-bottom: 1px solid #334155; position: relative;
        }
        .table-header th::after { 
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; 
            background: linear-gradient(90deg, transparent 0%, rgba(70,130,180,0.6) 50%, transparent 100%);
        }
        .section-title { 
            background: linear-gradient(135deg, #4682b4 0%, #6b7280 25%, #64748b 50%, #374151 75%, #4682b4 100%) !important;
            color: #fff !important; font-size: 2.2vw !important; font-weight: 900 !important;
            text-shadow: 0 0 6px rgba(70,130,180,0.6), 2px 2px 4px rgba(0,0,0,0.7) !important;
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.15), inset 0 -2px 4px rgba(75,85,99,0.4), 0 0 8px rgba(70,130,180,0.2) !important;
        }
        .price-row { background: #1e293b; transition: all 0.4s ease; border-bottom: 1px solid #334155; }
        .price-row:hover { 
            background: linear-gradient(135deg, rgba(70,130,180,0.15) 0%, rgba(75,85,99,0.12) 50%, rgba(100,116,139,0.14) 100%);
            transform: translateX(6px) scale(1.01); box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 10px rgba(70,130,180,0.2);
            border-left: 4px solid rgba(70,130,180,0.6);
        }
        .price-row:nth-child(even) { background: linear-gradient(135deg, rgba(75,85,99,0.07) 0%, rgba(0,0,0,0.78) 50%, rgba(55,65,81,0.05) 100%); }
        .price-row:nth-child(even):hover { background: linear-gradient(135deg, rgba(75,85,99,0.16) 0%, rgba(70,130,180,0.12) 50%, rgba(55,65,81,0.15) 100%); }
        .price-row td { padding: 1.8vh 1.5vw; text-align: center; font-size: 1.9vw; font-weight: 500; height: 7.5vh; vertical-align: middle; color: #fff; }
        .commodity, .buy-price, .sell-price { color: #fff; font-size: 1.9vw; font-weight: 500; }
        .price-up { color: #ef4444 !important; font-weight: 600 !important; }
        .price-down { color: #10b981 !important; font-weight: 600 !important; }
        .price-same { color: #fff !important; }
        .live-indicator { 
            animation: subtlePulse 2.5s infinite; display: inline-block; width: 1.2vw; height: 1.2vw; 
            background: radial-gradient(circle, #4682b4, #64748b); border-radius: 50%; margin-right: 1vw;
            box-shadow: 0 0 8px rgba(70,130,180,0.6), inset 0 2px 4px rgba(255,255,255,0.2);
            border: 2px solid rgba(70,130,180,0.5);
        }
        @keyframes subtlePulse { 
            0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 8px rgba(70,130,180,0.6); }
            50% { opacity: 0.85; transform: scale(1.08); box-shadow: 0 0 12px rgba(70,130,180,0.8), 0 0 16px rgba(75,85,99,0.4); }
        }
        .error-info { 
            color: #fbbf24; font-size: 1.2vw; text-align: center; padding: 0.5vh 1vw; 
            background: rgba(251, 191, 36, 0.1); border-radius: 6px; margin-top: 0.5vh;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        @media screen and (min-width: 1920px) { 
            .title { font-size: 3.8vw; } .timestamp { font-size: 1.8vw; } .table-header th { font-size: 2.4vw; padding: 1.5vh 1.2vw; }
            .price-row td { font-size: 2.1vw; height: 6.5vh; padding: 1.5vh 1.2vw; } .commodity, .buy-price, .sell-price { font-size: 2.1vw; }
        }
        @media screen and (min-width: 3840px) { 
            .title { font-size: 3.2vw; } .timestamp { font-size: 1.5vw; } .table-header th { font-size: 2vw; padding: 1.2vh 1vw; }
            .price-row td { font-size: 1.8vw; height: 6vh; padding: 1.2vh 1vw; } .commodity, .buy-price, .sell-price { font-size: 1.8vw; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">杰作打金黄金价盘</h1>
            <div class="timestamp">
                <span><span class="live-indicator"></span><span id="current-time">2025-08-06 20:03:02</span></span>
                <button id="manual-update-btn" style="background: linear-gradient(135deg, #4682b4, #6b7280); color: white; border: none; padding: 0.6vh 1.2vw; border-radius: 4px; font-size: 1.4vw; cursor: pointer; margin-left: 1vw; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(70, 130, 180, 0.3);" onclick="manualUpdate()" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">手动更新</button>
            </div>

            <div class="error-info" id="error-info" style="display: none;">正在尝试获取实时价格数据...</div>
        </div>
        <div class="price-tables-container">
            <div class="price-section">
                <table class="price-table">
                    <thead class="table-header">
                        <tr><th class="section-title">黄金纯度</th><th>价格（元/克）</th></tr>
                    </thead>
                    <tbody>
                        <tr class="price-row"><td class="commodity">黄金999 出售</td><td class="sell-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">黄金999 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">黄金990 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">黄金900 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">黄金18k 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">铂金999 出售</td><td class="sell-price price-same">--</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="price-section">
                <table class="price-table">
                    <thead class="table-header">
                        <tr><th class="section-title">贵金属</th><th>价格（元/克）</th></tr>
                    </thead>
                    <tbody>
                        <tr class="price-row"><td class="commodity">白银999 出售</td><td class="sell-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">白银999 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">白银990 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">白银925 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">铂金999 回收</td><td class="buy-price price-same">--</td></tr>
                        <tr class="price-row"><td class="commodity">铂金950 回收</td><td class="buy-price price-same">--</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        const API_ENDPOINTS = [
            // 使用CORS代理服务
            'https://cors-anywhere.herokuapp.com/https://api.jisuapi.com/gold/shgold?appkey=08dbbfa13b533c85',
            'https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.jisuapi.com/gold/shgold?appkey=08dbbfa13b533c85'),
            // 备用免费金价API
            'https://api.metals.live/v1/spot/gold',
            'https://api.coindesk.com/v1/bpi/currentprice.json'
        ];

        const SILVER_ENDPOINTS = [
            'https://cors-anywhere.herokuapp.com/https://api.jisuapi.com/silver/shgold?appkey=08dbbfa13b533c85',
            'https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.jisuapi.com/silver/shgold?appkey=08dbbfa13b533c85'),
            'https://api.metals.live/v1/spot/silver'
        ];

        let lastApiCallTime = 0, dailyCallCount = parseInt(localStorage.getItem('dailyApiCalls') || '0');
        let lastCallDate = localStorage.getItem('lastCallDate') || '', lastManualUpdateTime = 0;

        let lastGoldData = null, lastSilverData = null;
        let retryAttempts = 0, retryTimer = null;
        const instanceId = Date.now() + Math.random();
        let isMainInstance = false;
        let currentEndpointIndex = 0;

        const PRICE_RULES = {
            '黄金999 出售': (g) => g + 10, '黄金999 回收': (g) => g - 10, '黄金990 回收': (g) => g * 0.99,
            '黄金900 回收': (g) => g * 0.87, '黄金18k 回收': (g) => g * 0.7,
            '铂金999 出售': (p) => p + 20, '铂金999 回收': (p) => p - 30, '铂金950 回收': (p) => p * 0.9,
            '白银999 出售': (s) => (s / 1000) + 2, '白银999 回收': (s) => (s / 1000) - 1,
            '白银990 回收': (s) => (s / 1000) - 1.3, '白银925 回收': (s) => (s / 1000) - 1.8
        };

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + 
                ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
        }

        function showError(message) {
            const errorInfo = document.getElementById('error-info');
            if (errorInfo) {
                errorInfo.textContent = message;
                errorInfo.style.display = 'block';
                setTimeout(() => {
                    errorInfo.style.display = 'none';
                }, 5000);
            }
        }

        function checkMainInstance() {
            const currentMain = localStorage.getItem('mainInstanceId'), currentTime = Date.now();
            const lastHeartbeat = parseInt(localStorage.getItem('mainInstanceHeartbeat') || '0');
            if (!currentMain || currentTime - lastHeartbeat > 60000) {
                localStorage.setItem('mainInstanceId', instanceId.toString());
                localStorage.setItem('mainInstanceHeartbeat', currentTime.toString());
                return isMainInstance = true;
            } else if (currentMain === instanceId.toString()) {
                localStorage.setItem('mainInstanceHeartbeat', currentTime.toString());
                return isMainInstance = true;
            } else return isMainInstance = false;
        }

        function canMakeApiCall() {
            if (!checkMainInstance()) return false;
            const now = new Date(), today = now.toDateString();
            if (lastCallDate !== today) {
                dailyCallCount = 0;
                localStorage.setItem('dailyApiCalls', '0');
                localStorage.setItem('lastCallDate', today);
                lastCallDate = today;
            }
            return now.getTime() - lastApiCallTime >= 120000; // 2分钟间隔
        }
        
        function recordApiCall() {
            const now = new Date();
            lastApiCallTime = now.getTime();
            dailyCallCount++;
            localStorage.setItem('dailyApiCalls', dailyCallCount.toString());
            localStorage.setItem('lastApiCallTime', lastApiCallTime.toString());
        }

        function isInTradingHours() {
            const h = new Date().getHours();
            return h >= 8 && h < 22;
        }

        // 计算下次整点更新时间（每10分钟整点：8:10, 8:20, 8:30等）
        function getNextUpdateTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // 如果不在交易时间内，返回下一个交易时间的第一个更新点
            if (currentHour < 8) {
                // 早于8点，返回8:10
                const nextUpdate = new Date(now);
                nextUpdate.setHours(8, 10, 0, 0);
                return nextUpdate;
            } else if (currentHour >= 22) {
                // 晚于22点，返回明天8:10
                const nextUpdate = new Date(now);
                nextUpdate.setDate(nextUpdate.getDate() + 1);
                nextUpdate.setHours(8, 10, 0, 0);
                return nextUpdate;
            }
            
            // 在交易时间内，计算下一个10分钟整点
            const nextMinute = Math.ceil(currentMinute / 10) * 10;
            const nextUpdate = new Date(now);
            
            if (nextMinute >= 60) {
                // 需要进入下一小时
                const nextHour = currentHour + 1;
                if (nextHour >= 22) {
                    // 超过交易时间，返回明天8:10
                    nextUpdate.setDate(nextUpdate.getDate() + 1);
                    nextUpdate.setHours(8, 10, 0, 0);
                } else {
                    nextUpdate.setHours(nextHour, 0, 0, 0);
                }
            } else {
                nextUpdate.setMinutes(nextMinute, 0, 0);
            }
            
            return nextUpdate;
        }

        // 计算到下次更新的毫秒数
        function getMillisecondsToNextUpdate() {
            const nextUpdate = getNextUpdateTime();
            return nextUpdate.getTime() - Date.now();
        }

        // 尝试多个API端点获取数据
        async function fetchWithFallback(endpoints, isGold = true) {
            for (let i = 0; i < endpoints.length; i++) {
                try {
                    const endpoint = endpoints[i];
                    console.log(`尝试API端点 ${i + 1}:`, endpoint);
                    
                    let response;
                    if (endpoint.includes('allorigins.win')) {
                        response = await fetch(endpoint);
                        const data = await response.json();
                        if (data.contents) {
                            return JSON.parse(data.contents);
                        }
                    } else if (endpoint.includes('metals.live')) {
                        response = await fetch(endpoint);
                        const data = await response.json();
                        // 转换metals.live格式到我们需要的格式
                        if (isGold && data.price) {
                            return {
                                status: 0,
                                result: [{
                                    type: 'AU99.99',
                                    price: (data.price * 6.8).toFixed(2), // 美元转人民币大概汇率
                                    changepercent: '0'
                                }]
                            };
                        } else if (!isGold && data.price) {
                            return {
                                status: 0,
                                result: [{
                                    type: 'Ag99.99',
                                    price: (data.price * 6.8 * 31.1).toFixed(2), // 盎司转克，美元转人民币
                                    changepercent: '0'
                                }]
                            };
                        }
                    } else {
                        response = await fetch(endpoint, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json'
                            }
                        });
                        return await response.json();
                    }
                } catch (error) {
                    console.log(`API端点 ${i + 1} 失败:`, error.message);
                    if (i === endpoints.length - 1) {
                        throw new Error('所有API端点都失败了');
                    }
                }
            }
        }

        async function fetchRealTimeData(isRetry = false) {
            if (!canMakeApiCall()) return;
            
            try {
                showLoadingIndicator(true);
                showError('正在获取实时价格数据...');
                
                if (!isRetry) retryAttempts = 0;
                
                // 同时获取金价和银价数据
                const promises = [
                    fetchWithFallback(API_ENDPOINTS, true).then(data => {
                        if (data.status === 0 && data.result) {
                            lastGoldData = data.result;
                            console.log('金价数据获取成功:', data.result);
                            return { type: 'gold', success: true, data: data.result };
                        } else {
                            throw new Error(`金价API错误: ${data.status}`);
                        }
                    }).catch(error => {
                        console.error('金价获取失败:', error);
                        return { type: 'gold', success: false, error: error.message };
                    }),
                    
                    fetchWithFallback(SILVER_ENDPOINTS, false).then(data => {
                        if (data.status === 0 && data.result) {
                            lastSilverData = data.result;
                            console.log('银价数据获取成功:', data.result);
                            return { type: 'silver', success: true, data: data.result };
                        } else {
                            throw new Error(`银价API错误: ${data.status}`);
                        }
                    }).catch(error => {
                        console.error('银价获取失败:', error);
                        return { type: 'silver', success: false, error: error.message };
                    })
                ];
                
                const results = await Promise.all(promises);
                const goldResult = results.find(r => r.type === 'gold');
                const silverResult = results.find(r => r.type === 'silver');
                
                // 记录API调用（只要有一个成功就算调用）
                if (goldResult.success || silverResult.success) {
                    recordApiCall();
                }
                
                // 更新显示
                if (lastGoldData && lastSilverData) {
                    updateGoldPricesDisplay(lastGoldData, lastSilverData);
                    document.getElementById('error-info').style.display = 'none';
                    console.log('所有价格更新完成');
                } else if (lastGoldData || lastSilverData) {
                    // 即使只有一种数据，也使用可用数据更新价格
                    updatePricesWithAvailableData();
                    const missingData = !lastGoldData ? '金价' : '银价';
                    showError(`${missingData}数据获取失败，已更新其他价格`);
                } else {
                    throw new Error('所有价格数据获取失败');
                }
                
                retryAttempts = 0;
                
            } catch (error) {
                console.error('获取价格数据失败:', error);
                showError(`获取价格失败: ${error.message}`);
                
                if (!isRetry && retryAttempts < 2) {
                    if (retryTimer) { clearTimeout(retryTimer); retryTimer = null; }
                    retryAttempts++;
                    retryTimer = setTimeout(() => { 
                        retryTimer = null; 
                        fetchRealTimeData(true); 
                    }, 30000); // 30秒后重试
                    return;
                } else {
                    retryAttempts = 0;
                    // 如果所有API都失败，保持当前价格不变
                    showError('API连接失败，保持当前价格');
                }
            } finally {
                showLoadingIndicator(false);
            }
        }



        // 使用可用数据更新价格
        function updatePricesWithAvailableData() {
            if (lastGoldData) {
                const au9999Data = lastGoldData.find(item => item.type === 'AU99.99');
                if (au9999Data) {
                    const goldBasePrice = parseFloat(au9999Data.price);
                    const isGoldUp = parseFloat(au9999Data.changepercent || 0) >= 0;
                    
                    updateProductPrice('黄金999 出售', PRICE_RULES['黄金999 出售'](goldBasePrice), isGoldUp);
                    updateProductPrice('黄金999 回收', PRICE_RULES['黄金999 回收'](goldBasePrice), isGoldUp);
                    updateProductPrice('黄金990 回收', PRICE_RULES['黄金990 回收'](goldBasePrice), isGoldUp);
                    updateProductPrice('黄金900 回收', PRICE_RULES['黄金900 回收'](goldBasePrice), isGoldUp);
                    updateProductPrice('黄金18k 回收', PRICE_RULES['黄金18k 回收'](goldBasePrice), isGoldUp);
                }
            }
            
            if (lastSilverData) {
                const ag9999Data = lastSilverData.find(item => item.type === 'Ag99.99');
                if (ag9999Data) {
                    const silverBasePrice = parseFloat(ag9999Data.price);
                    const isSilverUp = parseFloat(ag9999Data.changepercent || 0) >= 0;
                    
                    updateProductPrice('白银999 出售', PRICE_RULES['白银999 出售'](silverBasePrice), isSilverUp);
                    updateProductPrice('白银999 回收', PRICE_RULES['白银999 回收'](silverBasePrice), isSilverUp);
                    updateProductPrice('白银990 回收', PRICE_RULES['白银990 回收'](silverBasePrice), isSilverUp);
                    updateProductPrice('白银925 回收', PRICE_RULES['白银925 回收'](silverBasePrice), isSilverUp);
                }
            }
        }



        function updateGoldPricesDisplay(goldData, silverData) {
            if (!goldData || goldData.length === 0 || !silverData || silverData.length === 0) return;
            const au9999Data = goldData.find(item => item.type === 'AU99.99');
            const pt9995Data = goldData.find(item => item.type === 'Pt99.95');
            const ag9999Data = silverData.find(item => item.type === 'Ag99.99');
            if (!au9999Data || !ag9999Data) return;
            const goldBasePrice = parseFloat(au9999Data.price), isGoldUp = parseFloat(au9999Data.changepercent || 0) >= 0;
            const silverBasePrice = parseFloat(ag9999Data.price), isSilverUp = parseFloat(ag9999Data.changepercent || 0) >= 0;
            let ptBasePrice = null, isPtUp = false;
            if (pt9995Data) {
                ptBasePrice = parseFloat(pt9995Data.price);
                isPtUp = parseFloat(pt9995Data.changepercent || 0) >= 0;
            }
            updateCalculatedPrices(goldBasePrice, isGoldUp, ptBasePrice, isPtUp, silverBasePrice, isSilverUp);
        }

        function updateCalculatedPrices(goldBasePrice, isGoldUp, ptBasePrice, isPtUp, silverBasePrice, isSilverUp) {
            updateProductPrice('黄金999 出售', PRICE_RULES['黄金999 出售'](goldBasePrice), isGoldUp);
            updateProductPrice('黄金999 回收', PRICE_RULES['黄金999 回收'](goldBasePrice), isGoldUp);
            updateProductPrice('黄金990 回收', PRICE_RULES['黄金990 回收'](goldBasePrice), isGoldUp);
            updateProductPrice('黄金900 回收', PRICE_RULES['黄金900 回收'](goldBasePrice), isGoldUp);
            updateProductPrice('黄金18k 回收', PRICE_RULES['黄金18k 回收'](goldBasePrice), isGoldUp);
            if (ptBasePrice !== null) {
                updateProductPrice('铂金999 出售', PRICE_RULES['铂金999 出售'](ptBasePrice), isPtUp);
                updateProductPrice('铂金999 回收', PRICE_RULES['铂金999 回收'](ptBasePrice), isPtUp);
                updateProductPrice('铂金950 回收', PRICE_RULES['铂金950 回收'](ptBasePrice), isPtUp);
            }
            updateProductPrice('白银999 出售', PRICE_RULES['白银999 出售'](silverBasePrice), isSilverUp);
            updateProductPrice('白银999 回收', PRICE_RULES['白银999 回收'](silverBasePrice), isSilverUp);
            updateProductPrice('白银990 回收', PRICE_RULES['白银990 回收'](silverBasePrice), isSilverUp);
            updateProductPrice('白银925 回收', PRICE_RULES['白银925 回收'](silverBasePrice), isSilverUp);
        }

        function updateProductPrice(productName, price, isUp) {
            const row = findRowByName(productName);
            if (row) {
                const priceElement = row.querySelector('.buy-price, .sell-price');
                if (priceElement) updatePriceElement(priceElement, price.toFixed(2), isUp);
            }
        }

        function findRowByName(name) {
            const rows = document.querySelectorAll('.price-row');
            for (let row of rows) {
                const commodity = row.querySelector('.commodity');
                if (commodity && commodity.textContent.includes(name)) return row;
            }
            return null;
        }

        function updatePriceElement(element, newPrice, isUp) {
            const newPriceNum = parseFloat(newPrice);
            if (isNaN(newPriceNum) || newPriceNum <= 0) return;
            const currentText = element.textContent, oldPrice = parseFloat(currentText);
            if (currentText === '--' || isNaN(oldPrice)) {
                element.textContent = newPriceNum.toFixed(2);
                element.classList.remove('price-up', 'price-down', 'price-same');
                element.classList.add('price-same');
                return;
            }
            const priceDiff = newPriceNum - oldPrice;
            let priceChangeClass = 'price-same';
            if (priceDiff > 0.01) priceChangeClass = 'price-up';
            else if (priceDiff < -0.01) priceChangeClass = 'price-down';
            element.classList.remove('price-up', 'price-down', 'price-same');
            element.classList.add(priceChangeClass);
            element.textContent = newPriceNum.toFixed(2);
            if (Math.abs(priceDiff) > 0.01) {
                element.style.background = priceDiff > 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)';
                element.style.transition = 'all 0.3s ease';
                setTimeout(() => { element.style.background = ''; }, 2000);
            }
        }

        function showLoadingIndicator(show) {
            const indicator = document.querySelector('.live-indicator');
            if (indicator) {
                indicator.style.background = show ? '#fbbf24' : '#4ade80';
                indicator.style.animation = show ? 'pulse 0.5s infinite' : 'subtlePulse 2.5s infinite';
            }
        }

        function manualUpdate() {
            const button = document.getElementById('manual-update-btn'), now = Date.now();
            if (now - lastManualUpdateTime < 30000 || button.disabled) return; // 30秒冷却
            button.disabled = true;
            button.textContent = '更新中...';
            button.style.background = 'linear-gradient(135deg, #6b7280, #94a3b8)';
            lastManualUpdateTime = now;
            retryAttempts = 0;
            fetchRealTimeData(false).finally(() => {
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = '手动更新';
                    button.style.background = 'linear-gradient(135deg, #4682b4, #6b7280)';
                }, 2000);
            });
        }

        // 设置下次整点更新的定时器
        function scheduleNextUpdate() {
            const msToNext = getMillisecondsToNextUpdate();
            const nextUpdate = getNextUpdateTime();
            
            console.log(`下次更新时间: ${nextUpdate.toLocaleString()}, ${Math.round(msToNext/1000)}秒后`);
            
            setTimeout(() => {
                if (isInTradingHours()) {
                    console.log('整点更新触发:', new Date().toLocaleString());
                    fetchRealTimeData();
                }
                // 设置下一次更新
                scheduleNextUpdate();
            }, msToNext);
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // 页面加载时立即更新一次
            console.log('页面加载完成，立即获取价格数据...');
            fetchRealTimeData();
            
            // 设置整点更新计划
            scheduleNextUpdate();
            
            // 主实例检查
            setInterval(() => { checkMainInstance(); }, 10000);
        });
    </script>
</body>
</html>
